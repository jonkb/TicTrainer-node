<!DOCTYPE html>
<html lang="en-us">
	<head>
		<title>View TicTrainer Logs</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/stylesheets/bgStyle.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/normalize.css">
	</head>
	<body>
    <section class="page-header">
			<div class="header-navbar">
				<a href="/" class="logo"></a>
				<h1>View TicTrainer Logs: **[admin_id]**</h1>
				<div style="clear: both;"></div>
			</div>
    </section>
    <section class="main-content">
			<form method="POST" name="PickLog" onsubmit="return false;">
				<fieldset>
					<legend>Choose a Log File to Load</legend>
					System Logs: <select name="sys_file" id="sys_option">
						<option value="-">Pick one</option>
						<!--Note: If debugging is high, the console log has user passwords in plain text-->
						<option value="../Project_Files/log.txt">Console Log</option>
						<option value="./error/log.ttd">Tt Error Log</option>
						<option value="./session/lnusers.ttd">Current Linking Users</option>
					</select>
					<button class="btn" style="float: right; margin-top: .25rem;" onclick="reqLog('sys');">Reload</button>
					<br>
					<div style="clear:right;"></div>
					Session Logs: <select name="ses_file" id="ses_option">
						<!--Filled in by script-->
					</select>
					For User: <input type="text" name="uid" id="uid_input" placeholder="u0000" size="6">
					<button class="btn" style="float: right; margin-top: .25rem;" onclick="load_ses_files(); reqLog('ses');">Reload</button>
				</fieldset>
			</form>
			<div id="log_content">
				<!--Filled in by script-->
			</div>
			<div id="download_link">
				<!--Filled in by script-->
			</div>
    </section>
		<script>
			//TO DO: Include download button
			//Load a list of session log files for ses_option
			function load_ses_files(){
				var uid = document.getElementById('uid_input').value;
				
				var xhr = new XMLHttpRequest();
				var url = '/admin/viewLogs.dynh';
				var reqBody = 'admin_id=**[admin_id]**&admin_pw=**[admin_pw]**&source=reqlist&uid='+uid;
				xhr.open('POST', url, true);
				xhr.setRequestHeader('Content-type', 'text/plain');
				xhr.onreadystatechange = function(){
					if(xhr.readyState == 4){
						if(xhr.status == 200){
							var loglist = JSON.parse(xhr.responseText);
							//text to fill ses_option
							var optionHTML = "<option value='-'>Pick one</option>\n";
							for(var i=0; i<loglist.length; i++){
								optionHTML += "<option value='./session/archive/"+loglist[i]+"'>"+loglist[i]+"</option>";
							}
							document.getElementById('ses_option').innerHTML = optionHTML;
						}
						else{
							document.open();
							document.write(xhr.responseText);
							document.close();
						}
					}
				};
				xhr.send(reqBody);
			}
			
			/*Parse plain text from a .ttd file to a table.
				.ttd files are organized like this: <~;~>\n<~;~;~>
				See the leaderboard scripts.
			*/
			function ttd_to_HTML(data){
				//Or I could say: if the first line is "Started at ..."
				if(data.indexOf("<") < 0 && data.indexOf(">") < 0){
					//This is probably .txt
					return data.replace(/\n/g,"<br>");
				}
				var html = "\n<table style='table-layout: auto;'>\n";
				for(var i = 0; i< data.length; i++){
					var character = data[i];
					switch(character){
						case "<":
							html += "<tr>\n<td>";
						break;
						case ">":
							html += "</td>\n</tr>\n";
						break;
						case ";":
							html += "</td>\n<td>";
						break;
						default:
							html += character;
						break;
					}
				}//For each character
				html += "</table>\n";
				return html;
			}
			
			/*Parse plain text from a .ttsd file to a table.
				.ttsd files are organized like this: 
					~|~
					~|~|~
					******
					Report:
					~|~
					~|~
			*/
			function ttsd_to_HTML(data){
				var html = "\n<table style='table-layout: auto;'>\n";
				var rows = data.split(/\s*\n\s*/);
				for(var i=0; i<rows.length; i++){
					var entries = rows[i].split("|");
					if(entries.length > 1){
						html += "<tr>\n";
						for(var j=0; j<entries.length; j++){
							html += "<td>" + entries[j] + "</td>\n";
						}
						html += "</tr>\n";
					}
					else if(rows[i] == "Report:"){
						//Divider Row
						html += "<tr><td style='height:0;border-bottom:1pt solid black;'></td></tr>\n";
					}
				}
				html += "</table>\n"
				return html;
			}
			
			/*To be used to request a log file from the server.
				type: "ses" or "sys" (for session or system)
			*/
			function reqLog(type){
				var logfile;
				if(type == "sys")
					logfile = document.getElementById('sys_option').value;
				else if(type == "ses")
					logfile = document.getElementById('ses_option').value;
				else
					return "error";
					
				if(!logfile){
					//This happens the first time
					return false;
				}
				if(logfile == "-"){
					return false;
				}
				
				//Show Loading animation
				document.getElementById("log_content").innerHTML = "<p style='text-align:center;'><img src='/media/loading.gif' alt='Loading' width='128' height='128' align='middle'></p>";
				
				//Ask the server for the log file and display it
				var xhr = new XMLHttpRequest();
				var url = '/admin/viewLogs.dynh';
				var reqBody = 'admin_id=**[admin_id]**&admin_pw=**[admin_pw]**&source=reqlog&file='+logfile;
				xhr.open('POST', url, true);
				xhr.setRequestHeader('Content-type', 'text/plain');
				xhr.onreadystatechange = function(){
					if(xhr.readyState == 4){
						if(xhr.status == 200){
							var loghtml = "";
							if(type == "sys")
								loghtml = ttd_to_HTML(xhr.responseText);
							else if(type == "ses")
								loghtml = ttsd_to_HTML(xhr.responseText);
							document.getElementById("log_content").innerHTML = loghtml;
							
							//Make download link
							var log_href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(xhr.responseText);
							var filename = logfile.slice(logfile.lastIndexOf("/")+1);
							document.getElementById("download_link").innerHTML = "<a href='"+log_href+"' class='btn' download='"+filename+"'>Download Log File<\a>";
						}
						else{
							document.open();
							document.write(xhr.responseText);
							document.close();
						}
					}
				};
				xhr.send(reqBody);
				return false;
			}
			
			load_ses_files();
			//Instead of using a submit button, 
			//Send the request as soon as they pick an option.
			document.getElementById('sys_option').onchange = function(){reqLog("sys");};
			document.getElementById('ses_option').onchange = function(){reqLog("ses");};
			//Maybe add a button too. For refresh?
			
		</script>
	</body>
</html>